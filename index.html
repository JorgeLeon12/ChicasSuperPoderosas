<!DOCTYPE html>
<html lang="es">
<head>
    <title>
        Performance
    </title>
</head>


<body>

    <div id="grafico">
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script type="text/javascript">

        var h = 480*1.5;
        var w = 4940*1.5;
        var datos = [];
        var actual= [];
        var names= [];
        var cuatrimestres = [];
        var length;

        d3.json('target.json', read);

        function randomColor() { 
            var letters = '0123456789ABCDEF'.split(''); 
            var color = '#';
            for (var i = 0; i < 6; i++ ) { 
                color += letters[Math.round(Math.random() * 15)]; 
            } 
            return color; 
        }

        function read(jsondata) {

            for(var i = 0; i < jsondata.teamPerformance.length; i++){
                datos[i] = jsondata.teamPerformance[i].finalTarget;
                actual[i]=jsondata.teamPerformance[i].data[jsondata.teamPerformance[i].data.length-1].amount;
                names[i]=jsondata.teamPerformance[i].name;
                cuatrimestres[i] = [];
                for(var j = 1; j < jsondata.teamPerformance[i].data.length-1; j++){
                    cuatrimestres[i][j] = jsondata.teamPerformance[i].data[j].amount;
                }

            }
            length=jsondata.teamPerformance.length;
            escale();       
        }

        function escale(){
            var minDataPoint = d3.min(datos);
            var maxDataPoint = d3.max(datos);

            var linearScale = d3.scale.linear()
            .domain([minDataPoint,maxDataPoint])
            .range([minDataPoint/2000,maxDataPoint/2000]);

            draw(linearScale);

        }

        function draw(linearScale){
            var svg = d3.select("body").append("svg")
            .attr("width", w)
            .attr("height", h);
            svg.append("image")
            .attr("width", w)
            .attr("height", h)
            .attr("xlink:href", "assets/background-mountains.svg");
            svg.append("image")
            .attr("width", w)
            .attr("height", h)
            .attr("xlink:href", "assets/background-sky.svg");
            var newFinalTarget = [];
            var newActual= [];
            var newCuatrimestres = [];
            var x = 0;
            var separacion = 20;
            for(var i = length-1; i >=0; i--){
                newFinalTarget[i] = linearScale(datos[i]);
                newActual[i] = linearScale(actual[i]);
                x+=newFinalTarget[i]*1.25-separacion;
                newCuatrimestres[i] = [];
                //Escala las lineas de los cuatrimestres
                for(var j = 1; j < cuatrimestres[i].length-1; j++){
                    newCuatrimestres[i][j] = linearScale(cuatrimestres[i][j]);
                }


            }
            x+=separacion;

            for(var i = length-1; i >=0; i--){

                svg.append("image")
                .attr("width", newFinalTarget[i]*1.25)
                .attr("height", newFinalTarget[i])
                .attr("x", x-newFinalTarget[i]*1.25)
                .attr("y", h-newFinalTarget[i])
                .attr("xlink:href", "assets/green-mountain.svg");

                



                if (newActual[i]>newFinalTarget[i]){
                    svg.append("image")
                    .attr("width", 60)
                    .attr("height", 84)
                    .attr("x", x-(newFinalTarget[i]*1.25/2)-30)
                    .attr("y", h-newActual[i]-84)
                    .attr("xlink:href", "assets/balloon.svg");

                    svg.append("circle")
                    .attr("cx", x-(newFinalTarget[i]*1.25/2))
                   
                    //.attr("cx", x+(newFinalTarget[i]*1.25)/2-newFinalTarget[i])
                    .attr("cy", h-newActual[i]+15)
                    .attr("r", 10)
                    .style("fill",randomColor());

                    svg.append("line")
                    .attr("x1", x-(newFinalTarget[i]*1.25/2))
                    .attr("x2", x-(newFinalTarget[i]*1.25/2))
                    .attr("y1", h-newFinalTarget[i])
                    .attr("y2", h-newActual[i]+15)
                    .style("stroke-width", "2")
                    .style("stroke", "black");

                    svg.append("circle")
                    .attr("cx", x-(newFinalTarget[i]*1.25/2))
                    .attr("cy", h-newActual[i]+15)
                    .attr("r", 4)
                    .style("fill","white");


                    

                }    

                else if (newActual[i]==newFinalTarget[i]){
                    svg.append("image")
                    .attr("width", 37.193)
                    .attr("height", 44.126)
                    .attr("x", x-(newFinalTarget[i]*1.25/2))
                    .attr("y", h-newFinalTarget[i]-44.126)
                    .attr("xlink:href", "assets/flag-annual-target.svg");

                    svg.append("circle")
                    .attr("cx", x-(newFinalTarget[i]*1.25/2))
                    .attr("cy", h-newActual[i])
                    .attr("r", 10)
                    .style("fill",randomColor());

                    svg.append("circle")
                    .attr("cx", x-(newFinalTarget[i]*1.25/2))
                    .attr("cy", h-newActual[i])
                    .attr("r", 4)
                    .style("fill","white");

                }

                else{

                    svg.append("image")
                    .attr("width", newFinalTarget[i]*1.25)
                    .attr("height", newFinalTarget[i]-newActual[i])
                    .attr("x", x-newFinalTarget[i]*1.25)
                    .attr("y", h-newFinalTarget[i])
                    .attr("xlink:href", "assets/mountain.svg");

                    svg.append("image")
                    .attr("width", newFinalTarget[i]*1.25)
                    .attr("height", newFinalTarget[i])
                    .attr("x", x-newFinalTarget[i]*1.25)
                    .attr("y", h-newFinalTarget[i])
                    .attr("xlink:href", "assets/TransMountain.svg");    


                    svg.append("circle")
                    .attr("cx", x - (newActual[i])/1.6)
                    .attr("cy", h-newActual[i])
                    .attr("r", 10)
                    .style("fill",randomColor());

                    svg.append("circle")
                    .attr("cx", x - (newActual[i])/1.6)
                    .attr("cy", h-newActual[i])
                    .attr("r", 4)
                    .style("fill","white");
                }

                var nombre= names[i];
                var text = svg.append("text")
                .text(function() {
                    var nomb =nombre.split();
                    var string="";
                    for(var j=0; j<nomb.length;j++){
                        string += nomb[j] + "\n\ " ;
                    }
                    
                    return string;
                })
                .attr("x", function() {return x-(newFinalTarget[i]*1.25/2);})
                .attr("text-anchor","middle")
                .attr("y", h-separacion)
                .attr("font-family","serif")
                .attr("font-size","11")
                .attr("fill", "white");


                //Dibuja lineas de cuatrimestres
                for(var j = 1; j < cuatrimestres[i].length-1; j++){
                    svg.append("line")
                    .attr("x1", x - (newCuatrimestres[i][j])/1.6)
                    .attr("y1", h - newCuatrimestres[i][j])
                    .attr("x2", x - (newCuatrimestres[i][j])/1.6 - (newFinalTarget[i] - newCuatrimestres[i][j])*1.25)
                    .attr("y2", h - newCuatrimestres[i][j])
                    .style("stroke-width", "2")
                    .style("stroke", "black")
                    .style("stroke-dasharray", ("3, 3"));

                }


                x -= newFinalTarget[i]*1.25-separacion;
            }


        }


        </script>
    </div>
</body>
</html>